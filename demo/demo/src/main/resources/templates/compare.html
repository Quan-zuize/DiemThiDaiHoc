<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>So s√°nh ƒëi·ªÉm ng√†nh</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
</head>
<body>
<div class="container mt-4">
    <h2>So s√°nh ƒëi·ªÉm c√°c tr∆∞·ªùng theo ng√†nh</h2>

    <!-- Dropdown ch·ªçn ng√†nh -->
    <div class="mb-3">
        <label for="fieldSelect" class="form-label">Ch·ªçn ng√†nh:</label>
        <select id="fieldSelect" name="fieldCode">-->
            <option value="">Ch·ªçn ng√†nh...</option>
            <option th:each="entry : ${fields.entrySet()}"
                    th:value="${entry.key}"
                    th:text="|[${entry.key}] ${fieldNames.get(entry.key)}|">
            </option>
        </select>
    </div>

    <!-- N√∫t So S√°nh -->
    <button id="compareBtn" class="btn btn-primary">So s√°nh</button>

    <!-- K·∫øt qu·∫£ hi·ªÉn th·ªã -->
    <div class="mt-4">
        <h4 id="fieldName"></h4>
        <div id="errorMsg" class="alert alert-danger d-none"></div>

        <!-- B·∫£ng k·∫øt qu·∫£ -->
        <table id="resultTable" class="table table-bordered table-striped d-none">
            <thead>
            <tr id="yearHeader">
                <th>Tr∆∞·ªùng</th> <!-- C·ªôt ƒë·∫ßu ti√™n l√† t√™n tr∆∞·ªùng -->
            </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function () {
        $('#fieldSelect').select2({
            placeholder: "Nh·∫≠p ƒë·ªÉ t√¨m ng√†nh...",
            allowClear: true
        });

        let table = $('#resultTable').DataTable({
            info: false,
            ordering: false,
            paging: false,
            searching: false
        });

        $("#compareBtn").click(function () {
            var fieldCode = $("#fieldSelect").val();
            if (!fieldCode) {
                alert("Vui l√≤ng ch·ªçn ng√†nh ƒë·ªÉ so s√°nh.");
                return;
            }

            $.ajax({
                url: "/compare/result",
                type: "POST",
                data: { fieldCode: fieldCode },
                success: function (response) {
                    if (response.error) {
                        $("#errorMsg").removeClass("d-none").text(response.error);
                        $("#resultTable").addClass("d-none");
                        return;
                    }

                    console.log("üìå D·ªØ li·ªáu t·ª´ server:", response);

                    // X√≥a d·ªØ li·ªáu c≈©
                    table.clear().destroy();
                    $("#yearHeader").empty().append("<th>Tr∆∞·ªùng</th>"); // Reset ti√™u ƒë·ªÅ c·ªôt
                    $("#resultBody").empty(); // X√≥a tbody ƒë·ªÉ tr√°nh l·ªói tr·ªëng
                    $("#fieldName").text(response.fieldName); // Hi·ªÉn th·ªã t√™n ng√†nh

                    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ c·ªôt (nƒÉm)
                    response.years.forEach(year => {
                        $("#yearHeader").append(`<th>${year}</th>`);
                    });

                    if (!response.universityPoints || Object.keys(response.universityPoints).length === 0) {
                        $("#errorMsg").removeClass("d-none").text("Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p.");
                        $("#resultTable").addClass("d-none");
                        return;
                    }

                    // Th√™m d·ªØ li·ªáu v√†o b·∫£ng
                    Object.entries(response.universityPoints).forEach(([universityName, points]) => {
                        let rowHtml = `<tr><td>${universityName}</td>`; // C·ªôt ƒë·∫ßu ti√™n l√† t√™n tr∆∞·ªùng
                        response.years.forEach(year => {
                            rowHtml += `<td>${points[year] || '-'}</td>`; // ƒêi·ªÉm theo nƒÉm
                        });
                        rowHtml += `</tr>`;
                        $("#resultBody").append(rowHtml);
                    });

                    // C·∫•u h√¨nh l·∫°i DataTable v·ªõi s·ªë c·ªôt ƒë·ªông
                    table = $('#resultTable').DataTable({
                        "paging": false,
                        "ordering": true,
                        "searching": false,
                        "order": [],
                        "destroy": true,
                        "columns": [{"title": "Tr∆∞·ªùng"}].concat(response.years.map(y => ({"title": y.toString()}))), // Chuy·ªÉn nƒÉm sang string
                        "columnDefs": [{ "orderable": false, "targets": 0 }]
                    });

                    // Hi·ªÉn th·ªã b·∫£ng
                    $("#resultTable").removeClass("d-none");
                    $("#errorMsg").addClass("d-none");
                },
                error: function () {
                    $("#errorMsg").removeClass("d-none").text("L·ªói khi l·∫•y d·ªØ li·ªáu.");
                    $("#resultTable").addClass("d-none");
                }
            });
        });
    });

</script>
</body>
</html>
